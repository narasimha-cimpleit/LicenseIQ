<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="1400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font: bold 28px sans-serif; fill: #1e293b; }
      .subtitle { font: 20px sans-serif; fill: #475569; }
      .label { font: 14px sans-serif; fill: #334155; }
      .tech { font: 12px sans-serif; fill: #64748b; }
      .box { fill: #ffffff; stroke: #3b82f6; stroke-width: 2; rx: 8; }
      .ai-box { fill: #dbeafe; stroke: #2563eb; stroke-width: 2; rx: 8; }
      .db-box { fill: #dcfce7; stroke: #16a34a; stroke-width: 2; rx: 8; }
      .process-box { fill: #fef3c7; stroke: #f59e0b; stroke-width: 2; rx: 8; }
      .arrow { stroke: #64748b; stroke-width: 3; fill: none; marker-end: url(#arrowhead); }
      .thick-arrow { stroke: #3b82f6; stroke-width: 4; fill: none; marker-end: url(#bluearrow); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#64748b"/>
    </marker>
    <marker id="bluearrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="40" class="title" text-anchor="middle">License IQ - End-to-End Architecture</text>
  <text x="600" y="70" class="subtitle" text-anchor="middle">Contract Upload → AI Analysis → Sales Matching → Calculation → Invoice</text>

  <!-- Contract Upload Section -->
  <rect class="box" x="50" y="100" width="300" height="120"/>
  <text x="200" y="130" class="label" text-anchor="middle" font-weight="bold">CONTRACT UPLOAD</text>
  <text x="200" y="155" class="tech" text-anchor="middle">User uploads PDF contract</text>
  <text x="200" y="175" class="tech" text-anchor="middle">• File validation (type, size)</text>
  <text x="200" y="195" class="tech" text-anchor="middle">• Multer file storage</text>
  <text x="200" y="210" class="tech" text-anchor="middle">→ uploads/contracts/</text>

  <!-- Storage -->
  <rect class="db-box" x="450" y="100" width="280" height="120"/>
  <text x="590" y="130" class="label" text-anchor="middle" font-weight="bold">DATABASE STORAGE</text>
  <text x="590" y="155" class="tech" text-anchor="middle">PostgreSQL + Drizzle ORM</text>
  <text x="590" y="175" class="tech" text-anchor="middle">• contracts table</text>
  <text x="590" y="195" class="tech" text-anchor="middle">• status: 'uploaded'</text>
  <text x="590" y="210" class="tech" text-anchor="middle">• file metadata stored</text>

  <path class="thick-arrow" d="M 350 160 L 450 160"/>

  <!-- PDF Extraction -->
  <rect class="process-box" x="850" y="100" width="300" height="120"/>
  <text x="1000" y="130" class="label" text-anchor="middle" font-weight="bold">PDF TEXT EXTRACTION</text>
  <text x="1000" y="155" class="tech" text-anchor="middle">pdf-parse library</text>
  <text x="1000" y="175" class="tech" text-anchor="middle">• Extract full text</text>
  <text x="1000" y="195" class="tech" text-anchor="middle">• Clean & format</text>
  <text x="1000" y="210" class="tech" text-anchor="middle">→ Ready for AI analysis</text>

  <path class="thick-arrow" d="M 730 160 L 850 160"/>

  <!-- AI Analysis Section -->
  <rect class="ai-box" x="50" y="280" width="400" height="140"/>
  <text x="250" y="315" class="label" text-anchor="middle" font-weight="bold">AI CONTRACT ANALYSIS</text>
  <text x="250" y="340" class="tech" text-anchor="middle">Groq LLaMA 3.1 8B Instant (FREE)</text>
  <text x="250" y="365" class="tech" text-anchor="middle">• Extract summary & key terms</text>
  <text x="250" y="385" class="tech" text-anchor="middle">• Identify risks & insights</text>
  <text x="250" y="405" class="tech" text-anchor="middle">• Extract royalty rules & formulas</text>

  <path class="arrow" d="M 600 220 L 600 250 L 250 250 L 250 280"/>

  <!-- Rule Extraction -->
  <rect class="ai-box" x="520" y="280" width="380" height="140"/>
  <text x="710" y="315" class="label" text-anchor="middle" font-weight="bold">ROYALTY RULE EXTRACTION</text>
  <text x="710" y="340" class="tech" text-anchor="middle">AI extracts structured formulas</text>
  <text x="710" y="365" class="tech" text-anchor="middle">• Volume tiers (0-4999: 1.25%, 5000+: 1.10%)</text>
  <text x="710" y="385" class="tech" text-anchor="middle">• Seasonal adjustments (Spring: 1.10x)</text>
  <text x="710" y="405" class="tech" text-anchor="middle">• Territory premiums (Secondary: 1.10x)</text>

  <!-- Embeddings Generation -->
  <rect class="ai-box" x="950" y="280" width="200" height="140"/>
  <text x="1050" y="315" class="label" text-anchor="middle" font-weight="bold">EMBEDDINGS</text>
  <text x="1050" y="340" class="tech" text-anchor="middle">Hugging Face</text>
  <text x="1050" y="360" class="tech" text-anchor="middle">BAAI/bge-small</text>
  <text x="1050" y="380" class="tech" text-anchor="middle">384-dim vectors</text>
  <text x="1050" y="400" class="tech" text-anchor="middle">→ RAG Search</text>

  <!-- Database Updates -->
  <rect class="db-box" x="250" y="470" width="500" height="120"/>
  <text x="500" y="500" class="label" text-anchor="middle" font-weight="bold">DATABASE UPDATES</text>
  <text x="500" y="525" class="tech" text-anchor="middle">contract_analysis • royalty_rules • contract_embeddings (pgvector)</text>
  <text x="500" y="545" class="tech" text-anchor="middle">• Summary, terms, insights saved</text>
  <text x="500" y="565" class="tech" text-anchor="middle">• Formula definitions (JSON expression trees)</text>
  <text x="500" y="580" class="tech" text-anchor="middle">• Contract status → 'analyzed'</text>

  <path class="arrow" d="M 250 420 L 250 450 L 500 450 L 500 470"/>
  <path class="arrow" d="M 710 420 L 710 450 L 500 450"/>
  <path class="arrow" d="M 1050 420 L 1050 450 L 750 450"/>

  <!-- Sales Upload -->
  <rect class="box" x="50" y="640" width="280" height="120"/>
  <text x="190" y="670" class="label" text-anchor="middle" font-weight="bold">SALES DATA UPLOAD</text>
  <text x="190" y="695" class="tech" text-anchor="middle">CSV/Excel import</text>
  <text x="190" y="715" class="tech" text-anchor="middle">• Parse with XLSX library</text>
  <text x="190" y="735" class="tech" text-anchor="middle">• Extract: product, qty, amount</text>
  <text x="190" y="750" class="tech" text-anchor="middle">→ sales_data table</text>

  <path class="arrow" d="M 500 590 L 500 620 L 190 620 L 190 640"/>

  <!-- AI Matching -->
  <rect class="ai-box" x="380" y="640" width="340" height="120"/>
  <text x="550" y="670" class="label" text-anchor="middle" font-weight="bold">AI SALES MATCHING</text>
  <text x="550" y="695" class="tech" text-anchor="middle">1. Generate sales embedding (HF)</text>
  <text x="550" y="715" class="tech" text-anchor="middle">2. pgvector similarity search (cosine)</text>
  <text x="550" y="735" class="tech" text-anchor="middle">3. LLM validation (Groq) → confidence</text>
  <text x="550" y="750" class="tech" text-anchor="middle">4. Auto-match if confidence >60%</text>

  <path class="thick-arrow" d="M 330 700 L 380 700"/>

  <!-- Matched Sales -->
  <rect class="db-box" x="770" y="640" width="380" height="120"/>
  <text x="960" y="670" class="label" text-anchor="middle" font-weight="bold">MATCHED SALES DATA</text>
  <text x="960" y="695" class="tech" text-anchor="middle">sales_data table updated</text>
  <text x="960" y="715" class="tech" text-anchor="middle">• matched_contract_id set</text>
  <text x="960" y="735" class="tech" text-anchor="middle">• match_confidence stored</text>
  <text x="960" y="750" class="tech" text-anchor="middle">→ Ready for calculation</text>

  <path class="thick-arrow" d="M 720 700 L 770 700"/>

  <!-- Royalty Calculation -->
  <rect class="process-box" x="150" y="820" width="400" height="140"/>
  <text x="350" y="855" class="label" text-anchor="middle" font-weight="bold">ROYALTY CALCULATION ENGINE</text>
  <text x="350" y="880" class="tech" text-anchor="middle">Formula Interpreter (FormulaNode trees)</text>
  <text x="350" y="900" class="tech" text-anchor="middle">1. Load rules for contract</text>
  <text x="350" y="920" class="tech" text-anchor="middle">2. Apply tiers, multipliers per sale</text>
  <text x="350" y="940" class="tech" text-anchor="middle">3. Calculate: qty × price × (tier%/100) × multipliers</text>
  <text x="350" y="955" class="tech" text-anchor="middle">→ Total royalty + line-by-line breakdown</text>

  <path class="arrow" d="M 960 760 L 960 790 L 350 790 L 350 820"/>

  <!-- Calculation Results -->
  <rect class="db-box" x="600" y="820" width="380" height="140"/>
  <text x="790" y="855" class="label" text-anchor="middle" font-weight="bold">CALCULATION RESULTS</text>
  <text x="790" y="880" class="tech" text-anchor="middle">contract_royalty_calculations</text>
  <text x="790" y="900" class="tech" text-anchor="middle">• Total sales amount</text>
  <text x="790" y="920" class="tech" text-anchor="middle">• Total royalty calculated</text>
  <text x="790" y="940" class="tech" text-anchor="middle">• Breakdown (JSONB): per-sale details</text>
  <text x="790" y="955" class="tech" text-anchor="middle">• Status: pending_approval</text>

  <path class="thick-arrow" d="M 550 890 L 600 890"/>

  <!-- PDF Invoice Generation -->
  <rect class="process-box" x="250" y="1020" width="700" height="160"/>
  <text x="600" y="1055" class="label" text-anchor="middle" font-weight="bold">PDF INVOICE GENERATION</text>
  <text x="600" y="1080" class="tech" text-anchor="middle">PDFKit (Node.js native, no browser needed)</text>
  
  <rect class="box" x="280" y="1095" width="300" height="70" opacity="0.8"/>
  <text x="430" y="1120" class="tech" text-anchor="middle" font-weight="bold">DETAILED INVOICE</text>
  <text x="430" y="1140" class="tech" text-anchor="middle">• Complete line items table</text>
  <text x="430" y="1155" class="tech" text-anchor="middle">• Calculation explanations</text>
  
  <rect class="box" x="620" y="1095" width="300" height="70" opacity="0.8"/>
  <text x="770" y="1120" class="tech" text-anchor="middle" font-weight="bold">SUMMARY INVOICE</text>
  <text x="770" y="1140" class="tech" text-anchor="middle">• High-level totals</text>
  <text x="770" y="1155" class="tech" text-anchor="middle">• Top products & statistics</text>

  <path class="arrow" d="M 790 960 L 790 990 L 600 990 L 600 1020"/>

  <!-- Final Output -->
  <rect class="box" x="350" y="1230" width="500" height="100"/>
  <text x="600" y="1265" class="label" text-anchor="middle" font-weight="bold">FINAL DELIVERABLE</text>
  <text x="600" y="1290" class="tech" text-anchor="middle">📄 Professional PDF Invoice → Client Download</text>
  <text x="600" y="1310" class="tech" text-anchor="middle">✅ Complete audit trail • Calculation transparency • Export ready</text>

  <path class="thick-arrow" d="M 600 1180 L 600 1230"/>

  <!-- Legend -->
  <text x="50" y="1370" class="tech" font-weight="bold">Technology Stack:</text>
  <text x="200" y="1370" class="tech">React + TypeScript</text>
  <text x="350" y="1370" class="tech">Express.js</text>
  <text x="470" y="1370" class="tech">PostgreSQL + pgvector</text>
  <text x="650" y="1370" class="tech">Groq LLaMA (FREE)</text>
  <text x="800" y="1370" class="tech">Hugging Face (FREE)</text>
  <text x="980" y="1370" class="tech">PDFKit</text>
</svg>
